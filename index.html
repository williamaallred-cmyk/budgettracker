<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Quick Entry Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
        }
        /* Custom focus styles for the category buttons */
        .category-button:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(66, 153, 225, 0.6); /* Blue shadow */
        }
        /* Style for the active category button */
        .category-button.active {
            @apply ring-4 ring-offset-2 ring-indigo-500 transform scale-[1.02];
        }
        /* Hidden class to control modal visibility and animation */
        .modal-hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-content-hidden {
            transform: scale(0.95);
            opacity: 0;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 md:p-8">

        <!-- Header -->
        <h1 class="text-3xl font-extrabold text-indigo-700 mb-2">üí∏ Quick Tracker</h1>
        <p class="text-gray-500 mb-6">Tap a category below to log an expense.</p>

        <!-- Current User Info -->
        <div class="mb-6 space-y-2">
            <div id="user-info" class="p-3 bg-indigo-50 rounded-lg text-sm text-indigo-800 border-l-4 border-indigo-400">
                <span class="font-semibold">Loading User...</span>
            </div>
            <div id="date-range-info" class="p-3 bg-green-50 rounded-lg text-sm text-green-800 border-l-4 border-green-400">
                <span class="font-semibold">Tracking since:</span> <span id="start-date-display">All time</span>
            </div>
        </div>
        
        <!-- ============================================== -->
        <!-- VIEW 1: EXPENSE TRACKER (Default) -->
        <!-- ============================================== -->
        <div data-view="tracker">
            
            <!-- Category Buttons (Now at the top) -->
            <div id="category-container" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6">
                <!-- Buttons will be injected here by JavaScript -->
            </div>

            <!-- Recent Transactions List -->
            <div class="mt-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Recent Entries (<span id="total-count">0</span>)</h2>
                <div id="recent-entries" class="space-y-3 max-h-80 overflow-y-auto pr-2">
                    <!-- Entries will be loaded here -->
                </div>
                <p id="loading-message" class="text-center text-gray-400 mt-4">Initializing database...</p>
            </div>
            
            <!-- Setup Buttons -->
            <div class="mt-6 pt-4 border-t border-gray-100 flex flex-wrap justify-center gap-3">
                <button 
                    id="setup-button" 
                    class="px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150"
                    onclick="switchView('budget-setup')"
                >
                    ‚öôÔ∏è Set Monthly Budgets
                </button>
                <button 
                    id="manage-categories-button" 
                    class="px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150"
                    onclick="switchView('category-management')"
                >
                    üè∑Ô∏è Manage Categories
                </button>
                <button 
                    id="view-logs-button" 
                    class="px-6 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 transition duration-150"
                    onclick="switchView('view-logs')"
                >
                    üìä View All Logs
                </button>
                <button 
                    id="set-start-date-button" 
                    class="px-6 py-2 bg-purple-500 text-white font-semibold rounded-lg hover:bg-purple-600 transition duration-150"
                    onclick="setStartDate()"
                >
                    üìÖ Set Start Date
                </button>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- VIEW 2: BUDGET SETUP -->
        <!-- ============================================== -->
        <div data-view="budget-setup" class="hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Monthly Budget Setup</h2>
            <p class="text-sm text-gray-500 mb-6">Enter your spending goal for each category this month.</p>

            <form id="budget-form" class="space-y-4">
                <!-- Budget inputs will be dynamically inserted here -->
            </form>

            <div class="flex justify-between mt-8 pt-4 border-t border-gray-100">
                <button 
                    id="back-button" 
                    class="px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150"
                    onclick="switchView('tracker')"
                    type="button"
                >
                    ‚Üê Back to Tracker
                </button>
                <button 
                    id="save-budgets-button" 
                    class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md"
                    type="submit"
                    form="budget-form"
                >
                    üíæ Save Budgets
                </button>
            </div>
            <p id="budget-status-message" class="text-sm text-center font-medium h-5 transition-opacity opacity-0 mt-4"></p>
        </div>

        <!-- ============================================== -->
        <!-- VIEW 3: CATEGORY MANAGEMENT -->
        <!-- ============================================== -->
        <div data-view="category-management" class="hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Manage Categories</h2>
            <p class="text-sm text-gray-500 mb-6">Add or remove expense categories.</p>

            <!-- Current Categories List -->
            <div id="category-list" class="space-y-3 mb-6">
                <!-- Categories will be dynamically inserted here -->
            </div>

            <!-- Add New Category Form -->
            <div class="bg-gray-50 p-4 rounded-lg border-2 border-dashed border-gray-300">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Add New Category</h3>
                <div class="space-y-3">
                    <input
                        type="text"
                        id="new-category-name"
                        placeholder="Category name (e.g., Entertainment)"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-0"
                    />
                    <input
                        type="text"
                        id="new-category-icon"
                        placeholder="Icon emoji (e.g., üé¨)"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-0"
                        maxlength="2"
                    />
                    <select
                        id="new-category-color"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-0"
                    >
                        <option value="">Select a color</option>
                        <option value="bg-indigo-500">Indigo</option>
                        <option value="bg-red-500">Red</option>
                        <option value="bg-yellow-500">Yellow</option>
                        <option value="bg-pink-500">Pink</option>
                        <option value="bg-purple-500">Purple</option>
                        <option value="bg-green-600">Green</option>
                        <option value="bg-cyan-500">Cyan</option>
                        <option value="bg-blue-500">Blue</option>
                        <option value="bg-orange-500">Orange</option>
                        <option value="bg-teal-500">Teal</option>
                        <option value="bg-emerald-500">Emerald</option>
                        <option value="bg-rose-500">Rose</option>
                    </select>
                    <button
                        id="add-category-button"
                        class="w-full px-6 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150"
                        onclick="addNewCategory()"
                    >
                        ‚ûï Add Category
                    </button>
                </div>
            </div>

            <div class="flex justify-between mt-8 pt-4 border-t border-gray-100">
                <button 
                    class="px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150"
                    onclick="switchView('tracker')"
                    type="button"
                >
                    ‚Üê Back to Tracker
                </button>
            </div>
            <p id="category-status-message" class="text-sm text-center font-medium h-5 transition-opacity opacity-0 mt-4"></p>
        </div>

        <!-- ============================================== -->
        <!-- VIEW 4: VIEW LOGS -->
        <!-- ============================================== -->
        <div data-view="view-logs" class="hidden">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">View All Logs</h2>
            <p class="text-sm text-gray-500 mb-6">Select a category to view all entries for this month.</p>

            <!-- Category Selection -->
            <div id="log-category-selector" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6">
                <!-- Category buttons will be dynamically inserted here -->
            </div>

            <!-- Selected Category Details -->
            <div id="log-details" class="hidden">
                <div class="bg-indigo-50 p-4 rounded-lg mb-4">
                    <h3 class="text-lg font-bold text-indigo-700 mb-2">
                        <span id="log-category-icon"></span> <span id="log-category-title"></span>
                    </h3>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Total Spent:</span>
                        <span id="log-category-total" class="font-bold text-red-600"></span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Budget:</span>
                        <span id="log-category-budget" class="font-bold text-gray-700"></span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-600">Remaining:</span>
                        <span id="log-category-remaining" class="font-bold"></span>
                    </div>
                </div>

                <!-- All Entries List -->
                <div class="space-y-2 max-h-96 overflow-y-auto">
                    <div id="log-entries-list">
                        <!-- Entries will be dynamically inserted here -->
                    </div>
                </div>
            </div>

            <div class="flex justify-between mt-8 pt-4 border-t border-gray-100">
                <button 
                    class="px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150"
                    onclick="switchView('tracker')"
                    type="button"
                >
                    ‚Üê Back to Tracker
                </button>
            </div>
        </div>

    </div>
    
    <!-- ============================================== -->
    <!-- EXPENSE INPUT MODAL -->
    <!-- ============================================== -->
    <div 
        id="expense-modal" 
        class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-50 transition-opacity duration-300 modal-hidden"
        onclick="if(event.target.id === 'expense-modal') closeModal()"
    >
        <div 
            id="modal-content"
            class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all duration-300 modal-content-hidden"
        >
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-700">Log Expense</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <p class="text-sm text-gray-500 mb-4">Category: <span id="modal-category-name" class="font-semibold text-indigo-600 text-base"></span></p>

            <div class="relative mb-6">
                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-3xl font-bold text-gray-400">$</span>
                <input
                    type="number"
                    id="modal-amount-input"
                    placeholder="Enter Amount"
                    class="w-full py-4 pl-10 pr-4 text-4xl font-mono text-gray-800 bg-gray-50 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-0 transition duration-150"
                    step="0.01"
                />
            </div>
            
            <p id="modal-status-message" class="text-sm text-center font-medium h-5 transition-opacity opacity-0 mb-4"></p>

            <button
                id="modal-save-button"
                class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-xl text-lg"
                onclick="saveExpenseFromModal()"
            >
                Log Transaction
            </button>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Use a fixed shared user ID so both you and your wife access the same data
        const SHARED_USER_ID = 'family-budget-shared';

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let currentCategory = null;
        let currentBudgets = {}; // Store current budgets globally
        let startDate = null; // Tracking start date

        const BUDGET_DOC_ID = 'monthly_budgets'; // Single document ID for budgets
        const CATEGORIES_DOC_ID = 'user_categories'; // Single document ID for categories
        const START_DATE_DOC_ID = 'tracking_start_date'; // Single document ID for start date

        // Default Category List (will be overridden by Firebase data)
        let categories = [
            { name: 'Shopping', color: 'bg-indigo-500', icon: 'üõçÔ∏è' },
            { name: 'Gas', color: 'bg-red-500', icon: '‚õΩ' },
            { name: 'Dining Out', color: 'bg-yellow-500', icon: 'üçï' },
            { name: 'Activities', color: 'bg-pink-500', icon: '‚öΩ' },
            { name: 'Medical', color: 'bg-purple-500', icon: 'üè•' },
            { name: 'Pets', color: 'bg-green-600', icon: 'üêæ' },
            { name: 'Groceries', color: 'bg-cyan-500', icon: 'üõí' },
        ];

        // --- DOM Elements ---
        const categoryContainer = document.getElementById('category-container');
        const recentEntriesDiv = document.getElementById('recent-entries');
        const loadingMessage = document.getElementById('loading-message');
        const userInfoDiv = document.getElementById('user-info');
        const totalCountSpan = document.getElementById('total-count');
        const budgetForm = document.getElementById('budget-form');
        const budgetStatusMessage = document.getElementById('budget-status-message');
        const views = document.querySelectorAll('[data-view]');
        
        // Modal Elements
        const expenseModal = document.getElementById('expense-modal');
        const modalContent = document.getElementById('modal-content');
        const modalCategoryName = document.getElementById('modal-category-name');
        const modalAmountInput = document.getElementById('modal-amount-input');
        const modalStatusMessage = document.getElementById('modal-status-message');
        
        // Category Management Elements
        const categoryList = document.getElementById('category-list');
        const categoryStatusMessage = document.getElementById('category-status-message');


        // --- Utility Functions ---

        /**
         * Formats a number as currency (USD), typically for buttons (whole dollars).
         * @param {number} amount
         * @returns {string}
         */
        function formatCurrency(amount) {
            // Use Math.abs to ensure positive formatting unless explicitly needed
            const absAmount = Math.abs(amount); 
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0, // Show whole dollars in the buttons for brevity
            }).format(absAmount).replace('$', ''); // Remove $ sign for cleaner button display
        }
        
        /**
         * Formats a number as currency (USD) with symbol and two decimal places.
         * @param {number} amount
         * @returns {string}
         */
        function formatDetailedCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
            }).format(amount);
        }

        /**
         * Displays a temporary status message inside the modal.
         * @param {string} message
         * @param {string} colorClass
         */
        function showModalStatus(message, colorClass = 'text-green-600') {
            modalStatusMessage.textContent = message;
            modalStatusMessage.className = `text-sm text-center font-medium h-5 transition-opacity opacity-100 ${colorClass} mb-4`;
            setTimeout(() => {
                modalStatusMessage.className = `text-sm text-center font-medium h-5 transition-opacity opacity-0 mb-4`;
            }, 3000);
        }

        /**
         * Displays a temporary status message in the budget view.
         * @param {string} message
         * @param {string} colorClass
         */
        function showBudgetStatus(message, colorClass = 'text-green-600') {
            budgetStatusMessage.textContent = message;
            budgetStatusMessage.className = `text-sm text-center font-medium h-5 transition-opacity opacity-100 ${colorClass} mt-4`;
            setTimeout(() => {
                budgetStatusMessage.className = `text-sm text-center font-medium h-5 transition-opacity opacity-0 mt-4`;
            }, 3000);
        }
        
        /**
         * Displays a temporary status message in the category management view.
         * @param {string} message
         * @param {string} colorClass
         */
        function showCategoryStatus(message, colorClass = 'text-green-600') {
            categoryStatusMessage.textContent = message;
            categoryStatusMessage.className = `text-sm text-center font-medium h-5 transition-opacity opacity-100 ${colorClass} mt-4`;
            setTimeout(() => {
                categoryStatusMessage.className = `text-sm text-center font-medium h-5 transition-opacity opacity-0 mt-4`;
            }, 3000);
        }

        // --- Modal Control ---
        
        function openModal() {
            expenseModal.classList.remove('modal-hidden');
            // Animate content in after a short delay
            setTimeout(() => {
                modalContent.classList.remove('modal-content-hidden');
                modalAmountInput.focus();
            }, 50); 
        }

        window.closeModal = function() {
            modalContent.classList.add('modal-content-hidden');
            // Hide container after transition
            setTimeout(() => {
                expenseModal.classList.add('modal-hidden');
                modalAmountInput.value = ''; // Clear input on close
                currentCategory = null; // Deselect category
                // Clear active button state
                categoryContainer.querySelectorAll('button').forEach(btn => {
                    btn.classList.remove('active');
                });
            }, 300);
        }
        
        // --- View Switching ---

        /**
         * Switches the visible view (page) in the single-file app.
         * Exposed globally for inline onclick handlers.
         * @param {string} viewName - The name of the view to show ('tracker' or 'budget-setup').
         */
        window.switchView = function(viewName) {
            views.forEach(view => {
                if (view.getAttribute('data-view') === viewName) {
                    view.classList.remove('hidden');
                } else {
                    view.classList.add('hidden');
                }
            });

            // If switching to budget setup, load current budgets
            if (viewName === 'budget-setup' && isAuthReady && userId) {
                loadAndRenderBudgets();
            }
            
            // If switching to category management, render the categories
            if (viewName === 'category-management' && isAuthReady && userId) {
                renderCategoryManagement();
            }
            
            // If switching to view logs, render category selector
            if (viewName === 'view-logs' && isAuthReady && userId) {
                renderLogCategorySelector();
                // Hide details initially
                const logDetails = document.getElementById('log-details');
                if (logDetails) logDetails.classList.add('hidden');
            }
        }

        // --- Firebase Core Functions ---

        /**
         * Initializes Firebase and handles authentication.
         */
        async function initializeFirebase() {
            try {
                // Check if firebaseConfig is loaded
                if (typeof firebaseConfig === 'undefined') {
                    throw new Error('Firebase configuration not found. Please create firebase-config.js file.');
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in anonymously (both users will use the shared user ID)
                await signInAnonymously(auth);

                // Auth State Listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Override with shared user ID so both users access same data
                        userId = SHARED_USER_ID;
                        isAuthReady = true;
                        console.log("Firebase Auth Ready. Using Shared User ID:", userId);
                        userInfoDiv.innerHTML = `<span class="font-semibold">Status:</span> Connected (Shared Family Budget)`;
                        
                        // Load categories and start date from Firebase first
                        await loadCategories();
                        await loadStartDate();
                        
                        // Start listening to data once authenticated
                        startBudgetListener(); // Must start budget listener first to populate currentBudgets
                    } else {
                        console.log("No user signed in.");
                        isAuthReady = true;
                        userId = null;
                        userInfoDiv.innerHTML = `<span class="font-semibold">Status:</span> Not Authenticated (Try reloading)`;
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or auth error:", error);
                loadingMessage.textContent = `Error initializing: ${error.message}`;
            }
        }

        /**
         * Saves a new expense entry to Firestore.
         * @param {string} category
         * @param {number} amount
         */
        async function saveExpense(category, amount) {
            if (!isAuthReady || !userId) {
                showModalStatus('Authentication not ready. Please wait.', 'text-red-500');
                return false;
            }

            if (isNaN(amount) || amount <= 0) { // Enforce positive amounts only for expenses
                showModalStatus('Please enter a valid, positive amount.', 'text-red-500');
                return false;
            }
            
            const data = {
                category: category,
                amount: amount,
                timestamp: serverTimestamp(),
                userId: userId, 
                type: 'expense' // All entries are expenses now
            };

            try {
                // Collection path: /users/{SHARED_USER_ID}/expenditures
                const expensesCollection = collection(db, `users/${userId}/expenditures`);
                await addDoc(expensesCollection, data);
                showModalStatus(`‚úÖ Saved ${formatDetailedCurrency(amount)} to ${category}!`, 'text-green-600');
                // Close immediately as requested
                closeModal(); 
                return true;
            } catch (e) {
                console.error("Error adding document: ", e);
                showModalStatus(`‚ùå Error saving: ${e.message}`, 'text-red-500');
                return false;
            }
        }

        /**
         * Sets up the real-time listener for expenses.
         * It calculates spending and updates all tracker UI elements.
         */
        function startExpenseListener() {
            if (!isAuthReady || !userId) return;

            loadingMessage.textContent = 'Fetching recent entries...';

            const expensesRef = collection(db, `users/${userId}/expenditures`);
            const q = query(expensesRef); 

            onSnapshot(q, (snapshot) => {
                const entries = [];
                let totalSpent = 0;
                // Accumulators for budget tracking 
                const categorySpending = {}; 
                categories.forEach(c => categorySpending[c.name] = 0);

                snapshot.forEach((doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    entries.push(data);
                });

                // Filter by start date
                const filteredEntries = filterEntriesByDate(entries);
                
                // Calculate totals from filtered entries
                filteredEntries.forEach((data) => {
                    if (data.amount > 0) {
                        totalSpent += data.amount;
                        if (categorySpending.hasOwnProperty(data.category)) {
                            categorySpending[data.category] += data.amount;
                        }
                    }
                });

                // Sort by timestamp (latest first)
                filteredEntries.sort((a, b) => {
                    const timeA = a.timestamp?.toMillis ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp?.toMillis ? b.timestamp.toMillis() : 0;
                    return timeB - timeA;
                });

                // Cache filtered entries for log viewing
                allEntriesCache = filteredEntries;

                // Update all tracker UI components
                updateTrackerUI(entries, totalSpent, categorySpending);

            }, (error) => {
                console.error("Error listening to expenses:", error);
                loadingMessage.textContent = `Error loading data: ${error.message}`;
            });
        }

        /**
         * Handles all main tracker UI updates in one place.
         * NOTE: Removed reliance on the old budget summary elements.
         * @param {Array<Object>} entries 
         * @param {number} totalSpent 
         * @param {Object} categorySpending 
         */
        function updateTrackerUI(entries, totalSpent, categorySpending) {
             // 1. Update overall totals and recent entries
            renderEntries(entries.slice(0, 10)); 
            totalCountSpan.textContent = entries.length;
            loadingMessage.style.display = 'none';

            // 2. Render/Update category buttons with remaining budget
            renderCategoryButtons(categorySpending);
        }
        
        /**
         * Sets up the real-time listener for the monthly budgets document.
         */
        function startBudgetListener() {
            if (!isAuthReady || !userId) return;
            
            const budgetDocRef = doc(db, `users/${userId}/budgets`, BUDGET_DOC_ID);
            
            onSnapshot(budgetDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentBudgets = docSnap.data();
                } else {
                    currentBudgets = {};
                }
                // When budgets change, we trigger the expense listener to re-run and update all UI
                startExpenseListener(); 
            }, (error) => {
                console.error("Error listening to budgets:", error);
            });
        }
        
        /**
         * Saves the monthly budget goals for all categories.
         * @param {Object} budgets - An object where keys are category names and values are budget amounts.
         */
        async function saveBudgets(budgets) {
             if (!isAuthReady || !userId) {
                showBudgetStatus('Authentication not ready. Please wait.', 'text-red-500');
                return;
            }
            
            const budgetDocRef = doc(db, `users/${userId}/budgets`, BUDGET_DOC_ID);
            
            try {
                await setDoc(budgetDocRef, budgets, { merge: true });
                showBudgetStatus('‚úÖ Monthly budgets saved successfully!', 'text-green-600');
            } catch (e) {
                console.error("Error saving budgets: ", e);
                showBudgetStatus(`‚ùå Error saving budgets: ${e.message}`, 'text-red-500');
            }
        }
        
        /**
         * Fetches the current monthly budget goals from Firestore (for setup page load).
         * @returns {Object} - An object of current budgets, or an empty object if none exist.
         */
        async function getBudgets() {
            if (!isAuthReady || !userId) return {};
            
            const budgetDocRef = doc(db, `users/${userId}/budgets`, BUDGET_DOC_ID);
            
            try {
                const docSnap = await getDoc(budgetDocRef);
                return docSnap.exists() ? docSnap.data() : {};
            } catch (e) {
                console.error("Error fetching budgets: ", e);
                return {};
            }
        }


        // --- Category Management Functions ---

        /**
         * Saves the categories list to Firestore.
         * @param {Array} categoriesArray - Array of category objects.
         */
        async function saveCategories(categoriesArray) {
            if (!isAuthReady || !userId) {
                showCategoryStatus('Authentication not ready. Please wait.', 'text-red-500');
                return;
            }
            
            const categoriesDocRef = doc(db, `users/${userId}/settings`, CATEGORIES_DOC_ID);
            
            try {
                await setDoc(categoriesDocRef, { categories: categoriesArray });
                showCategoryStatus('‚úÖ Categories saved successfully!', 'text-green-600');
            } catch (e) {
                console.error("Error saving categories: ", e);
                showCategoryStatus(`‚ùå Error saving categories: ${e.message}`, 'text-red-500');
            }
        }
        
        /**
         * Fetches the user's categories from Firestore.
         * @returns {Array} - Array of category objects.
         */
        async function getCategories() {
            if (!isAuthReady || !userId) return null;
            
            const categoriesDocRef = doc(db, `users/${userId}/settings`, CATEGORIES_DOC_ID);
            
            try {
                const docSnap = await getDoc(categoriesDocRef);
                return docSnap.exists() ? docSnap.data().categories : null;
            } catch (e) {
                console.error("Error fetching categories: ", e);
                return null;
            }
        }
        
        /**
         * Loads categories from Firebase and initializes the app with them.
         */
        async function loadCategories() {
            const savedCategories = await getCategories();
            if (savedCategories && savedCategories.length > 0) {
                categories = savedCategories;
            }
        }
        
        /**
         * Adds a new category.
         */
        window.addNewCategory = async function() {
            const nameInput = document.getElementById('new-category-name');
            const iconInput = document.getElementById('new-category-icon');
            const colorSelect = document.getElementById('new-category-color');
            
            const name = nameInput.value.trim();
            const icon = iconInput.value.trim();
            const color = colorSelect.value;
            
            if (!name) {
                showCategoryStatus('Please enter a category name.', 'text-red-500');
                return;
            }
            
            if (!icon) {
                showCategoryStatus('Please enter an icon emoji.', 'text-red-500');
                return;
            }
            
            if (!color) {
                showCategoryStatus('Please select a color.', 'text-red-500');
                return;
            }
            
            // Check if category already exists
            if (categories.some(cat => cat.name.toLowerCase() === name.toLowerCase())) {
                showCategoryStatus('Category already exists!', 'text-red-500');
                return;
            }
            
            // Add new category
            categories.push({ name, icon, color });
            
            // Save to Firebase
            await saveCategories(categories);
            
            // Clear inputs
            nameInput.value = '';
            iconInput.value = '';
            colorSelect.value = '';
            
            // Re-render
            renderCategoryManagement();
            renderCategoryButtons();
        }
        
        /**
         * Removes a category by name.
         */
        window.removeCategory = async function(categoryName) {
            if (!confirm(`Are you sure you want to remove "${categoryName}"? This will not delete existing transactions.`)) {
                return;
            }
            
            categories = categories.filter(cat => cat.name !== categoryName);
            
            // Save to Firebase
            await saveCategories(categories);
            
            // Re-render
            renderCategoryManagement();
            renderCategoryButtons();
        }
        
        /**
         * Renders the category management list.
         */
        function renderCategoryManagement() {
            if (!categoryList) return;
            
            categoryList.innerHTML = '';
            
            categories.forEach(cat => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200';
                categoryDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-12 h-12 ${cat.color} rounded-lg flex items-center justify-center text-2xl">
                            ${cat.icon}
                        </div>
                        <span class="font-medium text-gray-700">${cat.name}</span>
                    </div>
                    <button
                        onclick="removeCategory('${cat.name}')"
                        class="px-4 py-2 bg-red-500 text-white text-sm font-semibold rounded-lg hover:bg-red-600 transition duration-150"
                    >
                        Remove
                    </button>
                `;
                categoryList.appendChild(categoryDiv);
            });
        }


        // --- Log Viewing Functions ---
        
        let allEntriesCache = []; // Cache all entries for filtering
        
        /**
         * Renders the category selector buttons in the log view.
         */
        function renderLogCategorySelector() {
            const logCategorySelector = document.getElementById('log-category-selector');
            if (!logCategorySelector) return;
            
            logCategorySelector.innerHTML = '';
            
            categories.forEach(cat => {
                const button = document.createElement('button');
                button.className = `w-full p-3 font-semibold rounded-lg transition duration-150 transform hover:scale-[1.02] ${cat.color} shadow-lg flex items-center justify-center space-x-2`;
                button.innerHTML = `
                    <span class="text-lg">${cat.icon}</span>
                    <span class="text-white">${cat.name}</span>
                `;
                button.onclick = () => showCategoryLogs(cat.name);
                logCategorySelector.appendChild(button);
            });
        }
        
        /**
         * Shows detailed logs for a specific category.
         */
        function showCategoryLogs(categoryName) {
            const logDetails = document.getElementById('log-details');
            const logCategoryIcon = document.getElementById('log-category-icon');
            const logCategoryTitle = document.getElementById('log-category-title');
            const logCategoryTotal = document.getElementById('log-category-total');
            const logCategoryBudget = document.getElementById('log-category-budget');
            const logCategoryRemaining = document.getElementById('log-category-remaining');
            const logEntriesList = document.getElementById('log-entries-list');
            
            // Find category details
            const category = categories.find(cat => cat.name === categoryName);
            if (!category) return;
            
            // Filter entries for this category
            const categoryEntries = allEntriesCache.filter(entry => entry.category === categoryName);
            
            // Calculate totals
            const totalSpent = categoryEntries.reduce((sum, entry) => sum + (entry.amount || 0), 0);
            const budget = currentBudgets[categoryName] || 0;
            const remaining = budget - totalSpent;
            
            // Update header
            logCategoryIcon.textContent = category.icon;
            logCategoryTitle.textContent = categoryName;
            logCategoryTotal.textContent = formatDetailedCurrency(totalSpent);
            logCategoryBudget.textContent = budget > 0 ? formatDetailedCurrency(budget) : 'Not set';
            
            if (budget > 0) {
                if (remaining >= 0) {
                    logCategoryRemaining.textContent = formatDetailedCurrency(remaining);
                    logCategoryRemaining.className = 'font-bold text-green-600';
                } else {
                    logCategoryRemaining.textContent = formatDetailedCurrency(remaining);
                    logCategoryRemaining.className = 'font-bold text-red-600';
                }
            } else {
                logCategoryRemaining.textContent = 'N/A';
                logCategoryRemaining.className = 'font-bold text-gray-400';
            }
            
            // Render entries
            logEntriesList.innerHTML = '';
            
            if (categoryEntries.length === 0) {
                logEntriesList.innerHTML = '<p class="text-center text-gray-400 p-4">No entries for this category this month.</p>';
            } else {
                // Sort by date (newest first)
                categoryEntries.sort((a, b) => {
                    const timeA = a.timestamp?.toMillis ? a.timestamp.toMillis() : 0;
                    const timeB = b.timestamp?.toMillis ? b.timestamp.toMillis() : 0;
                    return timeB - timeA;
                });
                
                categoryEntries.forEach(entry => {
                    const date = entry.timestamp?.toDate ? entry.timestamp.toDate() : new Date();
                    const dateString = date.toLocaleString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        year: 'numeric',
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg border';
                    entryDiv.innerHTML = `
                        <span class="text-sm text-gray-500">${dateString}</span>
                        <span class="font-mono font-bold text-red-600">-${formatDetailedCurrency(entry.amount)}</span>
                    `;
                    logEntriesList.appendChild(entryDiv);
                });
            }
            
            // Show details section
            logDetails.classList.remove('hidden');
        }
        
        /**
         * Sets a new tracking start date.
         */
        window.setStartDate = async function() {
            if (!isAuthReady || !userId) {
                alert('Authentication not ready. Please wait and try again.');
                return;
            }
            
            const dateInput = prompt('Enter start date (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            
            if (!dateInput) return; // User cancelled
            
            const parsedDate = new Date(dateInput);
            if (isNaN(parsedDate.getTime())) {
                alert('Invalid date format. Please use YYYY-MM-DD');
                return;
            }
            
            try {
                const startDateDocRef = doc(db, `users/${userId}/settings`, START_DATE_DOC_ID);
                await setDoc(startDateDocRef, { startDate: parsedDate.toISOString() });
                
                startDate = parsedDate;
                updateStartDateDisplay();
                
                alert('‚úÖ Start date set successfully!');
                
            } catch (error) {
                console.error('Error setting start date:', error);
                alert(`‚ùå Error setting start date: ${error.message}`);
            }
        }
        
        /**
         * Loads the tracking start date from Firestore.
         */
        async function loadStartDate() {
            if (!isAuthReady || !userId) return;
            
            try {
                const startDateDocRef = doc(db, `users/${userId}/settings`, START_DATE_DOC_ID);
                const docSnap = await getDoc(startDateDocRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.startDate) {
                        startDate = new Date(data.startDate);
                    }
                }
                
                updateStartDateDisplay();
            } catch (error) {
                console.error('Error loading start date:', error);
            }
        }
        
        /**
         * Updates the start date display.
         */
        function updateStartDateDisplay() {
            const startDateDisplay = document.getElementById('start-date-display');
            if (startDateDisplay) {
                if (startDate) {
                    startDateDisplay.textContent = startDate.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                } else {
                    startDateDisplay.textContent = 'All time';
                }
            }
        }
        
        /**
         * Filters entries based on the start date.
         */
        function filterEntriesByDate(entries) {
            if (!startDate) return entries;
            
            return entries.filter(entry => {
                const entryDate = entry.timestamp?.toDate ? entry.timestamp.toDate() : new Date(0);
                return entryDate >= startDate;
            });
        }


        // --- UI Rendering Functions ---

        /**
         * Creates and renders the category buttons, including live budget remaining data.
         * @param {Object} categorySpending - Current spending totals for each category.
         */
        function renderCategoryButtons(categorySpending = {}) {
            categoryContainer.innerHTML = '';
            
            categories.forEach(cat => {
                const budget = currentBudgets[cat.name] || 0;
                const spent = categorySpending[cat.name] || 0;
                const remaining = budget - spent;
                
                let remainingText;
                let textColorClass = 'text-white';
                
                if (budget <= 0) {
                    remainingText = '(Budget not set)';
                    textColorClass = 'text-gray-200';
                } else if (remaining >= 0) {
                    remainingText = `($${formatCurrency(remaining)} remaining)`;
                    textColorClass = 'text-white';
                } else {
                    remainingText = `(OVER by $${formatCurrency(remaining)})`;
                    // Use a slightly different color for better contrast on the colored background
                    textColorClass = 'text-red-300 font-extrabold'; 
                }
                
                // Keep the 'active' class if it was the last selected category
                const isActiveClass = currentCategory === cat.name ? ' active' : '';

                const button = document.createElement('button');
                button.className = `category-button w-full p-3 font-semibold rounded-lg transition duration-150 transform hover:scale-[1.02] active:scale-100 ${cat.color} shadow-lg flex flex-col items-center justify-center space-y-1 ${isActiveClass}`;
                button.innerHTML = `
                    <span class="text-lg">${cat.icon} ${cat.name}</span>
                    <span class="text-xs ${textColorClass} font-mono">${remainingText}</span>
                `;
                button.onclick = () => selectCategory(cat.name);
                categoryContainer.appendChild(button);
            });
            
            // Re-apply active class if needed (important for visual feedback after selection)
            if (currentCategory) {
                categoryContainer.querySelectorAll('button').forEach(btn => {
                    if (btn.textContent.includes(currentCategory)) {
                        btn.classList.add('active');
                    }
                });
            }
        }
        
        /**
         * Renders the budget input fields in the budget setup view, loading current values.
         */
        async function loadAndRenderBudgets() {
            const budgetsToDisplay = await getBudgets();
            budgetForm.innerHTML = ''; // Clear previous fields
            
            // Render all categories for budget setting
            categories.forEach(cat => {
                const currentValue = budgetsToDisplay[cat.name] || '';
                
                const inputGroup = document.createElement('div');
                inputGroup.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-lg border';
                inputGroup.innerHTML = `
                    <span class="text-xl">${cat.icon}</span>
                    <label for="budget-${cat.name}" class="font-medium text-gray-700 w-1/3">${cat.name}</label>
                    <div class="relative flex-grow">
                        <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">$</span>
                        <input
                            type="number"
                            id="budget-${cat.name}"
                            name="${cat.name}"
                            value="${currentValue}"
                            placeholder="0.00"
                            class="w-full py-2 pl-8 pr-2 text-lg font-mono text-gray-800 bg-white border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-0"
                            step="0.01"
                            min="0"
                        />
                    </div>
                `;
                budgetForm.appendChild(inputGroup);
            });
        }

        /**
         * Renders the list of recent entries.
         * @param {Array<Object>} entries
         */
        function renderEntries(entries) {
            recentEntriesDiv.innerHTML = '';
            if (entries.length === 0) {
                recentEntriesDiv.innerHTML = '<p class="text-center text-gray-400 p-4 bg-gray-50 rounded-lg">No entries yet. Start tracking!</p>';
                return;
            }

            entries.forEach(entry => {
                const date = entry.timestamp?.toDate ? entry.timestamp.toDate() : new Date();
                const dateString = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) + ', ' + date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                // All transactions are considered expenses now
                const color = 'text-red-600'; 
                const sign = '-'; 
                const formattedAmount = formatDetailedCurrency(Math.abs(entry.amount));

                const entryDiv = document.createElement('div');
                entryDiv.className = 'flex justify-between items-center p-3 bg-white hover:bg-gray-50 rounded-lg shadow-sm border border-gray-100 transition duration-100';
                entryDiv.innerHTML = `
                    <div class="flex flex-col">
                        <span class="font-medium text-gray-800">${entry.category}</span>
                        <span class="text-xs text-gray-400">${dateString}</span>
                    </div>
                    <span class="font-mono font-bold ${color} text-lg">
                        ${sign}${formattedAmount}
                    </span>
                `;
                recentEntriesDiv.appendChild(entryDiv);
            });
        }


        // --- Interaction Logic ---

        /**
         * Handles category selection (opens the modal).
         * @param {string} categoryName
         */
        function selectCategory(categoryName) {
            // Deselect all buttons first
            categoryContainer.querySelectorAll('button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Set current category, update modal, and show modal
            currentCategory = categoryName;
            modalCategoryName.textContent = categoryName;
            
            // Apply active class to the newly selected button
            categoryContainer.querySelectorAll('button').forEach(btn => {
                if (btn.textContent.includes(categoryName)) {
                    btn.classList.add('active');
                }
            });

            openModal();
        }

        /**
         * Handles the final submission from the modal.
         * Exposed globally for inline onclick.
         */
        window.saveExpenseFromModal = async function() {
            if (!currentCategory) {
                showModalStatus('Category is missing. Close and re-select.', 'text-red-500');
                return;
            }

            const amountValue = parseFloat(modalAmountInput.value);

            if (isNaN(amountValue) || amountValue <= 0) { // Check for positive value
                showModalStatus('Please enter a valid, positive amount.', 'text-red-500');
                return;
            }

            // Attempt to save the expense
            await saveExpense(currentCategory, amountValue);

            // If save is successful, the modal is closed immediately inside saveExpense.
        }
        
        /**
         * Handles Enter key press inside the modal input.
         * @param {KeyboardEvent} event
         */
        function handleModalInputSubmission(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission if input was in a form
                saveExpenseFromModal();
            }
        }
        
        /**
         * Handles the submission of the budget form.
         * @param {Event} event
         */
        function handleBudgetSubmission(event) {
            event.preventDefault();
            const formData = new FormData(budgetForm);
            const newBudgets = {};
            
            for (const [key, value] of formData.entries()) {
                const amount = parseFloat(value);
                // Only save positive, non-zero, valid numbers as budgets
                if (!isNaN(amount) && amount > 0) {
                    newBudgets[key] = amount;
                } else {
                    newBudgets[key] = 0; // Default to 0 if invalid/empty/negative
                }
            }
            
            saveBudgets(newBudgets);
        }


        // --- Initialization ---

        window.onload = () => {
            renderCategoryButtons(); 
            initializeFirebase();
            // Bind Enter key to save function within the modal input field
            modalAmountInput.addEventListener('keydown', handleModalInputSubmission);
            budgetForm.addEventListener('submit', handleBudgetSubmission);
            
            switchView('tracker'); 
        };

    </script>
</body>
</html>